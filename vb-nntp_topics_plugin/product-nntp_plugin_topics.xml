<?xml version="1.0" encoding="ISO-8859-1"?>

<product productid="nntp_plugin_topics" active="1">
	<title>NNTP Gate Plugin: Forum Topics</title>
	<description />
	<version>1.6</version>
	<url />
	<versioncheckurl />
	<dependencies>
	</dependencies>
	<codes>
		<code version="1.0">
			<installcode><![CDATA[$db->hide_errors();

$db->query("
  CREATE TABLE IF NOT EXISTS `" . TABLE_PREFIX . "nntp_groups_forums` (
    `forumid` smallint(5) unsigned NOT NULL,
    `groupid` int(10) unsigned NOT NULL,
    PRIMARY KEY  (`forumid`),
    KEY `groupid` (`groupid`)
  ) ENGINE=MyISAM DEFAULT CHARSET=utf8;
");

$db->show_errors();]]></installcode>
			<uninstallcode><![CDATA[$db->query( "DROP TABLE IF EXISTS `" . TABLE_PREFIX . "nntp_groups_forums`;" );]]></uninstallcode>
		</code>
		<code version="1.6">
			<installcode><![CDATA[$db->hide_errors();
$db->query("
  ALTER TABLE `" . TABLE_PREFIX . "nntp_index` CHANGE `refid` `parentid` INT( 10 ) UNSIGNED NOT NULL 
");
$db->query("
  UPDATE
            `" . TABLE_PREFIX . "nntp_groups` AS ng, `" . TABLE_PREFIX . "nntp_groups_forums` AS ngf
        SET
            ng.map_id = ngf.forumid
        WHERE
            ng.id = ngf.groupid
");
$db->show_errors();]]></installcode>
			<uninstallcode><![CDATA[$db->query( "DROP TABLE IF EXISTS `" . TABLE_PREFIX . "nntp_groups_forums`;" );]]></uninstallcode>
		</code>
	</codes>
	<templates>
		<template name="postbit_nntp" templatetype="template" date="1258983509" username="e.shkuropat" version=""><![CDATA[<div>$post[message]</div>

<if condition="$show['attachments']">
	<br />

	<if condition="$show['thumbnailattachment']">
		$post[thumbnailattachments]
	</if>

	<if condition="$show['imageattachment']">
			$post[imageattachments]
	</if>

	<if condition="$show['imageattachmentlink']">
			$post[imageattachmentlinks]
	</if>

	<if condition="$show['otherattachment']">
			$post[otherattachments]
	</if>

</if>
        ]]></template>
	</templates>
	<plugins>
		<plugin active="1" executionorder="99">
			<title>edit post/thread</title>
			<hookname>editpost_update_complete</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_index.php';

$nntp_index = new NNTPGate_Forum_Index($vbulletin->db);
$nntp_index->set_post($edit);
$nntp_index->set_post_id( $postinfo['postid']);
$nntp_index->set_map_id( $foruminfo['forumid']);
$nntp_index->set_user_id($postinfo['userid']);
$nntp_index->set_parent_id ($threadinfo['threadid']);
$threadtitle = $threadman->fetch_field( 'title' );
$prefix = $threadman->fetch_field( 'prefixid' );

$nntp_index->make_message_title($vbphrase, $threadtitle, $prefix);
$nntp_index->save_message();]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="99">
			<title>delete forum</title>
			<hookname>forumdata_delete</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_group.php';
$nntp_group = new NNTPGate_Forum_Group();
if (!is_array($forumlist))
{
    $forumlist = explode(',', $forumlist);
}
foreach ($forumlist as $forum_id)
{
    $nntp_group->get_group_id_by_map_id($forum_id);
    $nntp_group->delete_group();
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="99">
			<title>move list of thread</title>
			<hookname>inlinemod_domovethread</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_index.php';
$nntp_index = new NNTPGate_Forum_Index($vbulletin->db);
$nntp_index->set_map_id( $foruminfo['forumid']);
$target_map_id = $destforuminfo['forumid'];
$target_group_id = $nntp_index->get_group_id_by_map_id($target_map_id, true);
$threads_list = array_keys($threadarray);
foreach ($threads_list as $target_parent_id)
{
    $nntp_index->move_posts_by_parent_id($target_group_id, $target_parent_id);
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="99">
			<title>add new post/thread</title>
			<hookname>newpost_complete</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_index.php';
$nntp_index = new NNTPGate_Forum_Index($vbulletin->db);
    $nntp_index->set_post($post);
    $nntp_index->set_post_id( $post['postid']);
    $nntp_index->set_map_id( $foruminfo['forumid']);
    $nntp_index->set_user_id($vbulletin->userinfo['userid']);
    $nntp_index->set_parent_id ($threadinfo['threadid']);
    $threadtitle = $threadinfo['title'];
    $prefix = $threadinfo['prefixid'];

    $nntp_index->make_message_title($vbphrase, $threadtitle, $prefix);
    $nntp_index->save_message();]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Check available groups list</title>
			<hookname>nntp_gate_backend_check_groups_list</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_group.php';
$nntp_group = new NNTPGate_Forum_Group();
$groups = $nntp_group->get_avaliable_group_list($membergroupids);
$activegroups = $activegroups + $groups;
unset($nntp_group);]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="10">
			<title>Show forum based groups</title>
			<hookname>nntp_gate_groups_list</hookname>
			<phpcode><![CDATA[print_form_header( $this_script, 'group_settings' );
print_table_header( $vbphrase['nntp_forum_based_groups_list'], 2 );
construct_hidden_code( 'plugin'  , 'forum' );
print_cells_row( array( $vbphrase['nntp_group_name'], $vbphrase['controls'] ), 1 );

require_once DIR . '/includes/class_nntpgate_forum_group.php';
$nntp_group = new NNTPGate_Forum_Group();
$forums_list = $vbulletin->forumcache;

$groups_list = $nntp_group->get_groups_list();

foreach ( $groups_list AS $group )
{
    $forum_id = $group['map_id'];
    $comment = $forums_list[$forum_id]['title'];
    $group['comment'] = $comment;
    $controls = form_group_control($group);
    print_cells_row( array(
            '<b>' . $group['group_name'] . '</b>'
            . ( !empty( $group['comment'] ) ? '<br />' . $group['comment'] : '' ),
            $controls
    ));
}
print_cells_row( array(
            '',
            construct_button_code($vbphrase['nntp_add_group'], 'submit')
        ));
print_table_footer( 2 );]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Add handler for forum based groups</title>
			<hookname>nntp_gate_group_handler</hookname>
			<phpcode><![CDATA[if ('forum' == $vbulletin->GPC['plugin'])
{
    require_once DIR . '/includes/class_nntpgate_forum_group.php';
    $nntp_group = new NNTPGate_Forum_Group();
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="10">
			<title>Show group settings</title>
			<hookname>nntp_gate_group_settings</hookname>
			<phpcode><![CDATA[if ('forum' == $vbulletin->GPC['plugin'])
{
    $selected_forum = $nntp_group->get_map_id();
    require_once DIR . '/includes/class_nntpgate_forum_group.php';
    $nntp_forum_group = new NNTPGate_Forum_Group();

    $group_list = $nntp_forum_group->get_groups_list();
    foreach ($group_list as $group)
    {
        $gated_forum_list[$group['map_id']] = true;
    }

    $allowed_forum_list = array();
    // collect a list of available forums, as well as their ancestors
    foreach ($vbulletin->forumcache as $forum_id=>$forum_info)
    {
        if ($forum_info['link'])
        {
            continue;
        }
        if (!($forum_info['options'] & $vbulletin->bf_misc_forumoptions['allowposting']) )
        {
            continue;
        }
        if(( $selected_forum != $forum_id) AND array_key_exists( $forum_id, $gated_forum_list ) )
        {
            continue;
        }
        $parent_list = explode(',', $forum_info['parentlist']);
        foreach ($parent_list as $parent_id)
        {
            $allowed_forum_list[(int)$parent_id] = true;
        }

    }
    // Key "-1", is a flag that parenting forums are no more.
    unset ($allowed_forum_list[-1]);
    $formed_elements = array();
    // forming an array for print_select_row
    foreach ($vbulletin->forumcache as $forum_id=>$forum_info)
    {
        if (array_key_exists( $forum_id, $allowed_forum_list ))
        {
            $formed_elements[$forum_id] = construct_depth_mark($forum_info['depth'] + 1, '--', $startdepth);
            $formed_elements[$forum_id] .= ' ' . $forum_info['title'];
        }
    }

    $forum_list = array($vbphrase['no_one']) + $formed_elements;
    print_select_row($vbphrase['forum'], 'map_id', $forum_list, $selected_forum);
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="10">
			<title>Add option to available groups list</title>
			<hookname>nntp_gate_plugins</hookname>
			<phpcode><![CDATA[$plugins['forum'] = 'forum topics';]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>delete post</title>
			<hookname>postdata_delete</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_index.php';
$index = new NNTPGate_Forum_Index();
$index->set_post_id($postid);
$index->delete_message_by_post_id();]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>thread delete post</title>
			<hookname>threaddata_delete</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_index.php';
$index = new NNTPGate_Forum_Index();
$forum_id = $this->fetch_field( 'forumid' );
$index->set_map_id($forum_id);
$index->get_group_id_by_map_id();
$index->set_parent_id($threadid);
$index->delete_message_by_parent_id();]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>move thread</title>
			<hookname>threadmanage_move_complete</hookname>
			<phpcode><![CDATA[if ('copy' != $method)
{
    require_once DIR . '/includes/class_nntpgate_forum_index.php';
    $nntp_index = new NNTPGate_Forum_Index($vbulletin->db);
    $nntp_index->set_map_id( $foruminfo['forumid']);
    $target_map_id = $destforuminfo['forumid'];
    $target_group_id = $nntp_index->get_group_id_by_map_id($target_map_id, true);
    $target_parent_id = $threadinfo['threadid'];
    $nntp_index->move_posts_by_parent_id($target_group_id, $target_parent_id);
}]]></phpcode>
		</plugin>
	</plugins>
	<phrases>
		<phrasetype name="Control Panel Global" fieldname="cpglobal">
			<phrase name="nntp_forum_based_groups_list" date="1217534551" username="Wildev" version=""><![CDATA[Existing forum based group list]]></phrase>
		</phrasetype>
	</phrases>
	<options>
	</options>
	<helptopics>
	</helptopics>
	<cronentries>
	</cronentries>
	<faqentries>
	</faqentries>
</product>
