<?xml version="1.0" encoding="ISO-8859-1"?>

<product productid="nntp_plugin_topics" active="1">
	<title>NNTP Gate Plugin: Forum Topics</title>
	<description />
	<version>1.6</version>
	<url />
	<versioncheckurl />
	<dependencies>
	</dependencies>
	<codes>
		<code version="1.0">
			<installcode><![CDATA[$db->hide_errors();

$db->query("
  CREATE TABLE IF NOT EXISTS `" . TABLE_PREFIX . "nntp_groups_forums` (
    `forumid` smallint(5) unsigned NOT NULL,
    `groupid` int(10) unsigned NOT NULL,
    PRIMARY KEY  (`forumid`),
    KEY `groupid` (`groupid`)
  ) ENGINE=MyISAM DEFAULT CHARSET=utf8;
");

$db->show_errors();]]></installcode>
			<uninstallcode><![CDATA[$db->query( "DROP TABLE IF EXISTS `" . TABLE_PREFIX . "nntp_groups_forums`;" );]]></uninstallcode>
		</code>
		<code version="1.6">
			<installcode><![CDATA[$db->hide_errors();
$db->query("
  ALTER TABLE `" . TABLE_PREFIX . "nntp_index` CHANGE `refid` `parentid` INT( 10 ) UNSIGNED NOT NULL 
");
$db->query("
  UPDATE
            `" . TABLE_PREFIX . "nntp_groups` AS ng, `" . TABLE_PREFIX . "nntp_groups_forums` AS ngf
        SET
            ng.map_id = ngf.forumid
        WHERE
            ng.id = ngf.groupid
");
$db->show_errors();]]></installcode>
			<uninstallcode><![CDATA[$db->query( "DROP TABLE IF EXISTS `" . TABLE_PREFIX . "nntp_groups_forums`;" );]]></uninstallcode>
		</code>
	</codes>
	<templates>
		<template name="postbit_nntp" templatetype="template" date="1258983509" username="e.shkuropat" version=""><![CDATA[<div>$post[message]</div>

<if condition="$show['attachments']">
	<br />

	<if condition="$show['thumbnailattachment']">
		$post[thumbnailattachments]
	</if>

	<if condition="$show['imageattachment']">
			$post[imageattachments]
	</if>

	<if condition="$show['imageattachmentlink']">
			$post[imageattachmentlinks]
	</if>

	<if condition="$show['otherattachment']">
			$post[otherattachments]
	</if>

</if>
        ]]></template>
	</templates>
	<plugins>
		<plugin active="1" executionorder="99">
			<title><![CDATA[edit post && thread]]></title>
			<hookname>editpost_update_complete</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_index.php';

$nntp_index = new NNTPGate_Forum_Index($vbulletin->db);
$nntp_index->set_post($edit);
$nntp_index->set_post_id( $postinfo['postid']);
$nntp_index->set_map_id( $foruminfo['forumid']);
$nntp_index->set_user_id($postinfo['userid']);
$nntp_index->set_parent_id ($threadinfo['threadid']);
$threadtitle = $threadman->fetch_field( 'title' );
$prefix = $threadman->fetch_field( 'prefixid' );

$nntp_index->make_message_title($vbphrase, $threadtitle, $prefix);
$nntp_index->save_message();]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Update forum info</title>
			<hookname>forumadmin_update_save</hookname>
			<phpcode><![CDATA[if( $vbulletin->GPC['forumid'] )
{
  require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
  nntp_gate_Topics_update_forum( $vbulletin->GPC['forumid'], $forumdata );
}]]></phpcode>
		</plugin>
		<plugin active="0" executionorder="5">
			<title>Delete forums</title>
			<hookname>forumdata_delete</hookname>
			<phpcode><![CDATA[if( $vbulletin->GPC['forumid'] )
{
  require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
  nntp_gate_Topics_delete_forums( $forumlist );
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="99">
			<title>delete forum</title>
			<hookname>forumdata_delete</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_group.php';
$nntp_group = new NNTPGate_Forum_Group();
if (!is_array($forumlist))
{
    $forumlist = explode(',', $forumlist);
}
foreach ($forumlist as $forum_id)
{
    $nntp_group->get_group_id_by_map_id($forum_id);
    $nntp_group->delete_group();
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="99">
			<title>move list of thrad</title>
			<hookname>inlinemod_domovethread</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_index.php';
$nntp_index = new NNTPGate_Forum_Index($vbulletin->db);
$nntp_index->set_map_id( $foruminfo['forumid']);
$target_map_id = $destforuminfo['forumid'];
$target_group_id = $nntp_index->get_group_id_by_map_id($target_map_id, true);
$threads_list = array_keys($threadarray);
foreach ($threads_list as $target_parent_id)
{
    $nntp_index->move_posts_by_parent_id($target_group_id, $target_parent_id);
}
]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="99">
			<title><![CDATA[add new post & thread]]></title>
			<hookname>newpost_complete</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_index.php';
$nntp_index = new NNTPGate_Forum_Index($vbulletin->db);
    $nntp_index->set_post($post);
    $nntp_index->set_post_id( $post['postid']);
    $nntp_index->set_map_id( $foruminfo['forumid']);
    $nntp_index->set_user_id($vbulletin->userinfo['userid']);
    $nntp_index->set_parent_id ($threadinfo['threadid']);
    $threadtitle = $threadinfo['title'];
    $prefix = $threadinfo['prefixid'];

    $nntp_index->make_message_title($vbphrase, $threadtitle, $prefix);
    $nntp_index->save_message();]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Check available groups list</title>
			<hookname>nntp_gate_backend_check_groups_list</hookname>
			<phpcode><![CDATA[require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
nntp_gate_Topics_check_groups_list($activegroups, $membergroupids);]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title><![CDATA[Create message's user menu]]></title>
			<hookname>nntp_gate_backend_user_menu</hookname>
			<phpcode><![CDATA[if ($group['plugin_id'] == 'forum')
{
  $menu = fetch_template('nntp_message_forum_menu');
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Delete specific group settings</title>
			<hookname>nntp_gate_group_delete_complete</hookname>
			<phpcode><![CDATA[if ( $vbulletin->GPC['plugin'] == 'forum' && $settings['group_id'] && $settings['forum_id'] )
{
  $db->query_write( "
    DELETE FROM
      `" . TABLE_PREFIX . "nntp_groups_forums`
    WHERE
      `groupid` = " . $db->escape_string( $vbulletin->GPC['group_id'] )
  );
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Delete group</title>
			<hookname>nntp_gate_group_delete_start</hookname>
			<phpcode><![CDATA[if ( $vbulletin->GPC['plugin'] == 'forum' )
{
  $db->query_write( "
    DELETE FROM
      `" . TABLE_PREFIX . "nntp_groups_forums`
    WHERE
      `groupid` = " . $db->escape_string( $vbulletin->GPC['group_id'] )
  );
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Group re-index</title>
			<hookname>nntp_gate_group_reindex</hookname>
			<phpcode><![CDATA[if ($group['plugin_id'] == 'forum')
{
  require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
  nntp_gate_Topics_group_reindex($group, $datelimit, $group_id);
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="10">
			<title>Save group settings</title>
			<hookname>nntp_gate_group_save_settings</hookname>
			<phpcode><![CDATA[if ( $vbulletin->GPC['plugin'] == 'forum' )
{
  require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
  nntp_gate_Topics_group_save_settings($settings);
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>Save specific group settings</title>
			<hookname>nntp_gate_group_save_settings_complete</hookname>
			<phpcode><![CDATA[if (   $vbulletin->GPC['plugin'] == 'forum'
    && $settings['group_id']
    && $settings['forum_id'] )
{
  require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
  nntp_gate_Topics_group_save_settings_complete($settings);
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="10">
			<title>Show group settings</title>
			<hookname>nntp_gate_group_settings</hookname>
			<phpcode><![CDATA[if ($vbulletin->GPC['plugin'] == 'forum')
{
  require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
  nntp_gate_Topics_group_settings($settings);
}]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="10">
			<title>Add option to available groups list</title>
			<hookname>nntp_gate_plugins</hookname>
			<phpcode><![CDATA[$plugins['forum'] = 'forum topics';]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="10">
			<title>Show possible to add groups</title>
			<hookname>nntp_gate_possible_groups_list</hookname>
			<phpcode><![CDATA[require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
nntp_gate_Topics_possible_groups_list($groups_list);]]></phpcode>
		</plugin>
		<plugin active="0" executionorder="5">
			<title>Delete post</title>
			<hookname>postdata_delete</hookname>
			<phpcode><![CDATA[require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
nntp_gate_Topics_delete_messages( $postid );]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>delete post</title>
			<hookname>postdata_delete</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_index.php';
$index = new NNTPGate_Forum_Index();
$forum_id = $this->fetch_field( 'forumid' );
$index->set_map_id($forum_id);
$index->get_group_id_by_map_id();
$index->set_post_id($postid);
$index->delete_message_by_post_id();]]></phpcode>
		</plugin>
		<plugin active="0" executionorder="100">
			<title>Add/update post, update thread</title>
			<hookname>postdata_postsave</hookname>
			<phpcode><![CDATA[require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
nntp_gate_Topics_postdata_postsave($this, $thread);]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>thread delete post</title>
			<hookname>threaddata_delete</hookname>
			<phpcode><![CDATA[require_once DIR . '/includes/class_nntpgate_forum_index.php';
$index = new NNTPGate_Forum_Index();
$forum_id = $this->fetch_field( 'forumid' );
$index->set_map_id($forum_id);
$index->get_group_id_by_map_id();
$index->set_parent_id($threadid);
$index->delete_message_by_parent_id();]]></phpcode>
		</plugin>
		<plugin active="0" executionorder="5">
			<title>Delete thread</title>
			<hookname>threaddata_delete</hookname>
			<phpcode><![CDATA[require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
nntp_gate_Topics_threaddata_delete($this, $threadid);]]></phpcode>
		</plugin>
		<plugin active="0" executionorder="100">
			<title>Add thread</title>
			<hookname>threadfpdata_postsave</hookname>
			<phpcode><![CDATA[require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
nntp_gate_Topics_threadfpdata_postsave($this);]]></phpcode>
		</plugin>
		<plugin active="0" executionorder="100">
			<title>Move thread</title>
			<hookname>threadmanage_move_complete</hookname>
			<phpcode><![CDATA[require_once(DIR . '/includes/functions_nntp_plugin_topics.php');
nntp_gate_Topics_threadmanage_move_complete();]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="5">
			<title>move thread</title>
			<hookname>threadmanage_move_complete</hookname>
			<phpcode><![CDATA[
if ('copy' != $method)
{
    require_once DIR . '/includes/class_nntpgate_forum_index.php';
    $nntp_index = new NNTPGate_Forum_Index($vbulletin->db);
    $nntp_index->set_map_id( $foruminfo['forumid']);
    $target_map_id = $destforuminfo['forumid'];
    $target_group_id = $nntp_index->get_group_id_by_map_id($target_map_id, true);
    $target_parent_id = $threadinfo['threadid'];
    $nntp_index->move_posts_by_parent_id($target_group_id, $target_parent_id);
}
]]></phpcode>
		</plugin>
	</plugins>
	<phrases>
		<phrasetype name="Control Panel Global" fieldname="cpglobal">
			<phrase name="nntp_forum_possible_groups" date="1249566809" username="Dimit" version=""><![CDATA[Possible to add forums based groups]]></phrase>
			<phrase name="nntp_group_mapped_to" date="1218113247" username="Wildev" version=""><![CDATA[->]]></phrase>
			<phrase name="nntp_map_to_group" date="1218109298" username="Wildev" version=""><![CDATA[Map to existing group]]></phrase>
		</phrasetype>
	</phrases>
	<options>
	</options>
	<helptopics>
	</helptopics>
	<cronentries>
	</cronentries>
	<faqentries>
	</faqentries>
</product>
